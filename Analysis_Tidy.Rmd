---
title: "Analysis of PSF Model"
author: "Hengxing Zou"
date: "2023-11-24"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

source("Functions_PSF.R")
source("ModelFitting.R")

# Unless otherwise specified, data_dir should always be "Standard"

data_dir = "Data/Standard/"

```

Notes on data and file names:
1. The name of raw data (i.e., data simulated from the plant-soil feedback model) has three components:
- `ij` or `ijk`: data generated from two- or three-plant models;
- `al`, `nc`, or `co`: representing different degrees of overlap between microbiomes; `al` represents $v_{ji} = 0.3V_i$, `nc` represents $v_{ji}=0$, and `co` represents $v_{ji}=0.6V_i$ (see also Figure 2);
- `ts` or `rs`: `ts` represents data generated from a time series, `rs` represents data generated by a response surface design for one year (see Methods).

# Two-Plant Models

## Read Data and Model Fitting

- Read Data

```{r}

# Time series, for population dynamics
ij_al_ts = read_csv(paste0(data_dir, "ij_al_ts.csv"))
ij_nc_ts = read_csv(paste0(data_dir, "ij_nc_ts.csv"))
ij_co_ts = read_csv(paste0(data_dir, "ij_co_ts.csv"))

# Response surface, for model fitting
ij_al_rs = read_csv(paste0(data_dir, "ij_al_rs.csv"))
ij_nc_rs = read_csv(paste0(data_dir, "ij_nc_rs.csv"))
ij_co_rs = read_csv(paste0(data_dir, "ij_co_rs.csv"))

```

- Model Fitting

```{r}

tau = 12
lc_len = 6

max_arriv = tau-lc_len-1

arriv_combns_ij = expand_grid(seq(0, max_arriv, 1), seq(0, max_arriv, 1), 0)

# Initials for model fitting

inits = c(lambda = 3, alpha_intra = 0.2, alpha_inter = 0.2)
lowers = c(lambda = 1, alpha_intra = -3, alpha_inter = -3)
uppers = c(lambda = 5, alpha_intra = 3, alpha_inter = 3)

nls_ctrl = nls.control(maxiter = 1000, tol = 1e-8, minFactor = (1/10)*(1/1024),
                       printEval = FALSE, warnOnly = FALSE)

alphas_ij_al_rs = fit_all_2(arriv_combns_ij, ij_al_rs, c(1, 2)) %>% mutate(pij = pj-pi)
alphas_ij_nc_rs = fit_all_2(arriv_combns_ij, ij_nc_rs, c(1, 2)) %>% mutate(pij = pj-pi)
alphas_ij_co_rs = fit_all_2(arriv_combns_ij, ij_co_rs, c(1, 2)) %>% mutate(pij = pj-pi)

```

## Population Dynamics

- Combine Data

```{r}

dta_all_2 = bind_rows(
  ij_al_ts %>% 
    mutate(type = "semi_ic"), 
  ij_nc_ts %>% 
    mutate(type = "no_ic"), 
  ij_co_ts %>% 
    mutate(type = "yes_ic"), 
)

```

- Visualization

```{r}

# Find final population

end_pop_vals = dta_all_2 %>% 
  mutate(Season = Time%/%tau) %>% 
  filter(Time %% tau == 0, 
        Group %in% c("Microbes", "Seeds"), 
        Season == max(Season)) %>% 
  filter(pi == 0, pj == 4) %>% 
  filter(Species != 3) %>% 
  select(Population, type, Species, Group) %>% 
  mutate(Time = 60)

# Plotting

p_pop_2spp = 
dta_all_2 %>% 
  filter(Group != "Seeds") %>% 
  filter(pi == 0, pj == 4) %>% 
  filter(Species != 3) %>% 
  ggplot(aes(x = Time, y = log(Population+1))) + 
  geom_line(aes(linetype = Group, color = as.factor(Species))) + 
  ylab("log(Density+1)") +
  # xlim(0, 120) +
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48, 60),
                     labels = c(0, 1, 2, 3, 4, 5),
                     limits = c(0, 60), name = "Time (in years)") +
  scale_color_manual(values = color_scheme_3, name = "Species", guide = "none") +
  scale_linetype_manual(values = c(2, 1), name = "", labels = c("Microbiomes", "Plants")) +
  facet_wrap(~ type, strip.position = "top", 
             labeller = labeller(type = c(semi_ic = "Low Overlap",
                                          no_ic = "No Overlap", 
                                          yes_ic = "High Overlap"))) +
  ggtitle("A") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), legend.position = "bottom", 
        panel.grid.minor = element_blank(), 
        plot.title = element_text(size = 20),
        strip.text.x = element_blank(), strip.background = element_blank())

p_pop_2spp = 
  p_pop_2spp + 
  geom_point(data = end_pop_vals, size = 3, 
             aes(color = as.factor(Species), shape = Group)) + 
  scale_shape_manual(values = c(1, 16), guide = "none")

p_pop_2spp

```

## Competition-phenology Functions

```{r}

alphas_all_2 = bind_rows(
  alphas_ij_al_rs %>% 
    filter(pk == 0) %>%
    filter(pi == 0 | pj == 0) %>% 
    arrange(pij) %>% 
    mutate(type = "semi_ic"),
  alphas_ij_nc_rs %>% 
    filter(pk == 0) %>%
    filter(pi == 0 | pj == 0) %>% 
    arrange(pij) %>% 
    mutate(type = "no_ic"), 
  alphas_ij_co_rs %>% 
    filter(pk == 0) %>%
    filter(pi == 0 | pj == 0) %>% 
    arrange(pij) %>% 
    mutate(type = "yes_ic"), 
)

p_alpha_2spp = 
alphas_all_2 %>% 
  pivot_longer(c(alphaii, alphaij, alphaji, alphajj), names_to = "Coeff", values_to = "Value") %>%
  filter(Coeff %in% c("alphaij", "alphaji")) %>%
  # filter(type != "yes_ic") %>%
  ggplot(aes(x = pij, y = Value, color = Coeff)) + 
  geom_line() + 
  geom_point(size = 3) + 
  scale_x_continuous(name = expression(paste(Delta, p[ij])), 
                     breaks = seq(-5, 5, 1)) +
  ylab("Coefficients") +
  scale_color_manual(values = color_scheme_3, 
                     name = "", labels = c(expression(alpha[ij]), expression(alpha[ji]))) +
  facet_wrap(~ type, strip.position = "top", 
             labeller = labeller(type = c(semi_ic = "Low Overlap",
                                          no_ic = "No Overlap", 
                                          yes_ic = "High Overlap"))) +
  ggtitle("B") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), legend.position = "bottom", 
        panel.grid.minor = element_blank(), 
        plot.title = element_text(size = 20),
        strip.text.x = element_blank(), strip.background = element_blank())

p_alpha_2spp

```

## Figure for Two-plant Models

- Using all three overlap values

Setting `data_dir` to `Data/Standard/` produces Figure S2;
Setting `data_dir` to `Data/m_ii_small/` produces Figure S5;
Setting `data_dir` to `Data/m_ij_small/` produces Figure S6.

```{r, eval = F}

ggsave("Plots/TwoSppComm.png", plot = p_pop_2spp / p_alpha_2spp, 
       device = "png", width = 3000, height = 2400, units = "px")

```

- Using no overlap only (Figure 2)

```{r, eval = F}

p_pop_2spp = 
dta_all_2 %>% 
  filter(Group != "Seeds") %>% 
  filter(pi == 0, pj == 4) %>% 
  filter(Species != 3) %>% 
  filter(type == "no_ic") %>% 
  ggplot(aes(x = Time, y = log(Population+1))) + 
  geom_line(aes(linetype = Group, color = as.factor(Species))) + 
  ylab("log(Density+1)") +
  # xlim(0, 120) +
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48, 60),
                     labels = c(0, 1, 2, 3, 4, 5),
                     limits = c(0, 60), name = "Time (in years)") +
  scale_color_manual(values = color_scheme_3, name = "Species", guide = "none") +
  scale_linetype_manual(values = c(2, 1), name = "", labels = c("Microbiomes", "Plants")) +
  ggtitle("A") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), legend.position = "bottom", 
        panel.grid.minor = element_blank(), 
        plot.title = element_text(size = 20),
        strip.text.x = element_blank(), strip.background = element_blank())

p_pop_2spp = 
  p_pop_2spp + 
  geom_point(data = end_pop_vals %>% filter(type == "no_ic"), size = 3, 
             aes(color = as.factor(Species), shape = Group)) + 
  scale_shape_manual(values = c(1, 16), guide = "none")

p_alpha_2spp = 
alphas_all_2 %>% 
  pivot_longer(c(alphaii, alphaij, alphaji, alphajj), names_to = "Coeff", values_to = "Value") %>%
  filter(Coeff %in% c("alphaij", "alphaji")) %>%
  filter(type == "no_ic") %>%
  ggplot(aes(x = pij, y = Value, color = Coeff)) + 
  geom_line() + 
  geom_point(size = 3) + 
  scale_x_continuous(name = expression(paste(Delta, p[ij])), 
                     breaks = seq(-5, 5, 1)) +
  ylab("Coefficients") +
  scale_color_manual(values = color_scheme_3, 
                     name = "", labels = c(expression(alpha[ij]), expression(alpha[ji]))) +
  ggtitle("B") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), legend.position = "bottom", 
        panel.grid.minor = element_blank(), 
        plot.title = element_text(size = 20),
        strip.text.x = element_blank(), strip.background = element_blank())

p_alpha_2spp

ggsave("Plots/TwoSppComm.pdf", plot = p_pop_2spp | p_alpha_2spp, 
       device = "pdf", width = 3000, height = 1500, units = "px")

```

# Three-plant Models

## Read Data

```{r}

# Time series, for population dynamics
ijk_al_ts = read_csv(paste0(data_dir, "ijk_al_ts.csv"))
ijk_nc_ts = read_csv(paste0(data_dir, "ijk_nc_ts.csv"))
ijk_co_ts = read_csv(paste0(data_dir, "ijk_co_ts.csv"))

# Response surface, for model fitting
ijk_al_rs = read_csv(paste0(data_dir, "ijk_al_rs.csv"))
ijk_nc_rs = read_csv(paste0(data_dir, "ijk_nc_rs.csv"))
ijk_co_rs = read_csv(paste0(data_dir, "ijk_co_rs.csv"))

```

## Population Dynamics

- Combine Data

```{r}

dta_all = bind_rows(
  ijk_al_ts %>% 
    filter(pi == 0, pj == 5, pk == 2) %>% 
    mutate(type = "semi_ic"), 
  ijk_nc_ts %>% 
    filter(pi == 0, pj == 5, pk == 2) %>% 
    mutate(type = "no_ic"), 
  ijk_co_ts %>% 
    filter(pi == 0, pj == 5, pk == 2) %>% 
    mutate(type = "yes_ic"), 
)

```

- Visualization

```{r}

# Find final population

end_pop_vals = dta_all %>% 
  mutate(Season = Time%/%tau) %>% 
  filter(Time %% tau == 0, 
        Group %in% c("Microbes", "Seeds"), 
        Season == max(Season)) %>% 
  select(Population, type, Species, Group) %>% 
  mutate(Time = 60)

# Plotting

p_pop_3spp = 
dta_all %>% 
  filter(Group != "Seeds") %>% 
  ggplot(aes(x = Time, y = log(Population+1))) + 
  geom_line(aes(linetype = Group, color = as.factor(Species))) + 
  ylab("log(Density+1)") +
  # xlim(0, 120) +
  scale_x_continuous(breaks = c(0, 12, 24, 36, 48, 60),
                     labels = c(0, 1, 2, 3, 4, 5),
                     limits = c(0, 60), name = "Time (in years)") +
  scale_color_manual(values = color_scheme_3, name = "Species", guide = "none") +
  scale_linetype_manual(values = c(2, 1), name = "", labels = c("Microbiomes", "Plants")) +
  facet_wrap(~ type, strip.position = "top", 
             labeller = labeller(type = c(semi_ic = "Low Overlap",
                                          no_ic = "No Overlap", 
                                          yes_ic = "High Overlap"))) +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), legend.position = "bottom", 
        panel.grid.minor = element_blank(), 
        plot.title = element_text(size = 20),
        strip.text.x = element_blank(), strip.background = element_blank())

p_pop_3spp = 
  p_pop_3spp + 
  geom_point(data = end_pop_vals, size = 3, 
             aes(color = as.factor(Species), shape = Group)) + 
  scale_shape_manual(values = c(1, 16), guide = "none")

p_pop_3spp

```

Setting `data_dir` to `Data/Standard/` produces Figure S4.

```{r}

ggsave("Plots/Pop3Spp.png", plot = p_pop_3spp, 
       device = "png", width = 3000, height = 1200, units = "px")

```

## End Population

- Combine Data

```{r}

dta_bef = rbind(
  ijk_al_ts %>% 
    filter(pi == 5, pj == 5) %>% 
    mutate(type = "semi_ic"),
  ijk_nc_ts %>% 
    filter(pi == 5, pj == 5) %>% 
    mutate(type = "no_ic"),
  ijk_co_ts %>% 
    filter(pi == 5, pj == 5) %>% 
    mutate(type = "yes_ic")
) %>% mutate(case = "I")

dta_aft = rbind(
  ijk_al_ts %>% 
    filter(pi == 0, pj == 0) %>% 
    mutate(type = "semi_ic"),
  ijk_nc_ts %>% 
    filter(pi == 0, pj == 0) %>% 
    mutate(type = "no_ic"),
  ijk_co_ts %>% 
    filter(pi == 0, pj == 0) %>% 
    mutate(type = "yes_ic")
) %>% mutate(case = "III")

dta_btw = rbind(
  ijk_al_ts %>% 
    filter(pi == 0, pj == 5) %>% 
    mutate(type = "semi_ic"),
  ijk_nc_ts %>% 
    filter(pi == 0, pj == 5) %>% 
    mutate(type = "no_ic"),
  ijk_co_ts %>% 
    filter(pi == 0, pj == 5) %>% 
    mutate(type = "yes_ic")
) %>% mutate(case = "II")

```

- Visualization

```{r}

p_endpop = 
rbind(dta_bef, dta_aft, dta_btw) %>% 
  mutate(Season = Time%/%tau, 
         pk = pk + 1) %>% 
  filter(Time %% tau == 0, 
        Group == "Seeds", 
        Season == max(Season)) %>% # use max(Season) for end population
  ggplot(aes(x = pk, y = Population, color = as.factor(Species))) + 
  geom_point(position = position_dodge(width = 0.5), size = 3) + 
  geom_line(position = position_dodge(width = 0.5)) +
  scale_x_continuous(breaks = seq(1, 6, 1), name = expression(paste(p[k]))) +
  scale_y_continuous(name = "Density") +
  scale_color_manual(values = color_scheme_3, name = "", label = c("i", "j", "k")) + 
  ggh4x::facet_grid2(case ~ type, #scales = "free_y", independent = "y",
             labeller = labeller(type = c(semi_ic = "Low Overlap", 
                                          no_ic = "No Overlap", 
                                          yes_ic = "High Overlap"), 
                                 case = c(I = "I. Before", II = "II. Between", III = "III. After"))) +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), legend.position = "bottom", 
        panel.grid.minor = element_blank(), 
        strip.text = element_text(size = 15))

p_endpop

```

Setting `data_dir` to `Data/Standard/` produces Figure 4;
Setting `data_dir` to `Data/m_ii_small/` produces Figure S7;
Setting `data_dir` to `Data/m_ij_small/` produces Figure S8.

```{r, eval = F}

ggsave("Plots/EndPop.pdf", plot = p_endpop, 
       device = "pdf", width = 2400, height = 2400, units = "px")

```

## Microbiome Density between Different $p_k$s

- Average Microbiome Densities

```{r}

avg_microb = rbind(
  ijk_nc_ts %>% 
    filter(Group == "Microbes", pi == 5, pj == 5) %>% 
    mutate(case = "I", type = "no_ic"),
  ijk_nc_ts %>% 
    filter(Group == "Microbes", pi == 0, pj == 0) %>% 
    mutate(case = "III", type = "no_ic"), 
  ijk_nc_ts %>% 
    filter(Group == "Microbes", pi == 0, pj == 5) %>% 
    mutate(case = "II", type = "no_ic"), 
  ijk_al_ts %>% 
    filter(Group == "Microbes", pi == 5, pj == 5) %>% 
    mutate(case = "I", type = "semi_ic"),
  ijk_al_ts %>% 
    filter(Group == "Microbes", pi == 0, pj == 0) %>% 
    mutate(case = "III", type = "semi_ic"), 
  ijk_al_ts %>% 
    filter(Group == "Microbes", pi == 0, pj == 5) %>% 
    mutate(case = "II", type = "semi_ic"), 
  ijk_co_ts %>% 
    filter(Group == "Microbes", pi == 5, pj == 5) %>% 
    mutate(case = "I", type = "yes_ic"), 
  ijk_co_ts %>% 
    filter(Group == "Microbes", pi == 0, pj == 0) %>% 
    mutate(case = "III", type = "yes_ic"), 
  ijk_co_ts %>% 
    filter(Group == "Microbes", pi == 0, pj == 5) %>% 
    mutate(case = "II", type = "yes_ic"))

p_avg_microb_spp = 
avg_microb %>% 
  mutate(Season = Time%/%tau+1) %>% 
  filter(Season %in% 1) %>% # change years here
  # filter(Species != 3) %>% # change species here
  group_by(Season, Species, type, case, pi, pj, pk) %>% 
  mutate(AvgPop = mean(Population)) %>% 
  ungroup() %>% 
  ggplot(aes(x = pk+1, y = AvgPop, color = as.factor(Species))) + 
  geom_line(position = position_dodge(width = 0.5)) + 
  geom_point(position = position_dodge(width = 0.5), size = 3) + 
  xlab(expression(p[k])) +
  ylab("Average Microbe Density") + 
  scale_color_manual(values = color_scheme_3, name = "Species", label = c("i", "j", "k")) +
  ggh4x::facet_grid2(case ~ type, #scales = "free_y", independent = "y",
             labeller = labeller(case = c(I = "I. Before", II = "II. Between", III = "III. After"), 
                                              type = c(semi_ic = "Low Overlap", no_ic = "No Overlap", yes_ic = "High Overlap"))) + 
  theme_bw() + 
  theme(axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), legend.position = "bottom", 
        panel.grid.minor = element_blank(), strip.text = element_text(size = 15)) + 
  guides(alpha = guide_legend(title = expression(paste(p[k]))))

p_avg_microb_spp

```

Setting `data_dir` to `Data/Standard/` produces Figure S3.

```{r}

ggsave("Plots/AvgMicrobSpp.png", plot = p_avg_microb_spp, 
       device = "png", width = 2400, height = 2400, units = "px")

```

# All HOIs over Time

## Model Fitting

```{r}

tau = 12
lc_len = 6

max_arriv = tau-lc_len-1

# Initials for the model fitting

inits = c(lambda = 3, alpha_intra = 0.2, alpha_inter1 = 0.2, alpha_inter2 = 0.2, 
          beta_112 = 0.2, beta_113 = 0.2, beta_123 = 0.2)
lowers = c(lambda = 1, alpha_intra = -3, alpha_inter1 = -3, alpha_inter2 = -3, 
           beta_112 = -3, beta_113 = -3, beta_123 = -3)
uppers = c(lambda = 5, alpha_intra = 3, alpha_inter1 = 3, alpha_inter2 = 3, 
           beta_112 = 3, beta_113 = 3, beta_123 = 3)

nls_ctrl = nls.control(maxiter = 1000, tol = 1e-8, minFactor = (1/10)*(1/1024),
                       printEval = FALSE, warnOnly = FALSE)

arriv_combns = rbind(tibble(i = 0, j = 0, k = seq(0, max_arriv, 1)),
                     tibble(i = max_arriv, j = max_arriv, k = seq(0, max_arriv, 1)),
                     tibble(i = 0, j = max_arriv, k = seq(0, max_arriv, 1))) %>%
  distinct()

alphabetas_al = fit_all_hoi(arriv_combns, ijk_al_rs) %>%
  mutate(pij = pj-pi, pjk = pk-pj, pik = pk-pi)
alphabetas_nc = fit_all_hoi(arriv_combns, ijk_nc_rs) %>%
  mutate(pij = pj-pi, pjk = pk-pj, pik = pk-pi)
alphabetas_co = fit_all_hoi(arriv_combns, ijk_co_rs) %>%
  mutate(pij = pj-pi, pjk = pk-pj, pik = pk-pi)

```

## Visualization

```{r}

alphabetas_al_rs = alphabetas_al %>% 
  pivot_longer(starts_with("beta"), 
               names_to = "Coeff", values_to = "Value") %>% 
  mutate(type = "semi_ic")

alphabetas_nc_rs = alphabetas_nc %>% 
  pivot_longer(starts_with("beta"), 
               names_to = "Coeff", values_to = "Value") %>% 
  mutate(type = "no_ic")

alphabetas_co_rs = alphabetas_co %>% 
  pivot_longer(starts_with("beta"), 
               names_to = "Coeff", values_to = "Value") %>% 
  mutate(type = "yes_ic")

dta_bef = rbind(alphabetas_al_rs, alphabetas_nc_rs, alphabetas_co_rs) %>% 
  filter(pi == 5, pj == 5) %>% 
  mutate(case = "I")

dta_aft = rbind(alphabetas_al_rs, alphabetas_nc_rs, alphabetas_co_rs) %>% 
  filter(pi == 0, pj == 0) %>% 
  mutate(case = "III")

dta_btw = rbind(alphabetas_al_rs, alphabetas_nc_rs, alphabetas_co_rs) %>% 
  filter(pi == 0, pj == 5) %>% 
  mutate(case = "II")

betas = rbind(dta_bef, dta_aft, dta_btw) %>% 
  mutate(pk = pk+1)

p_softhoi = 
  betas %>% 
  filter(Coeff %in% c("betaiik", "betajjk")) %>% 
  ggplot(aes(x = pk, y = Value, color = Coeff)) + 
  geom_point(position = position_dodge(width = 0.5), size = 3) + 
  geom_line(position = position_dodge(width = 0.5)) + 
  scale_x_continuous(breaks = seq(1, 6, 1), name = expression(paste(p[k]))) +
  scale_y_continuous(name = "HOI Coefficient Value") +
  scale_color_manual(values = color_scheme_3, name = "", 
                     labels = c(expression(beta[i(ik)]), expression(beta[j(jk)]))) + 
  ggh4x::facet_grid2(case ~ type, #scales = "free_y", independent = "y",
             labeller = labeller(type = c(semi_ic = "Low Overlap", 
                                          no_ic = "No Overlap", 
                                          yes_ic = "High Overlap"), 
                                 case = c(I = "I. Before", II = "II. Between", III = "III. After"))) +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), legend.position = "bottom", 
        panel.grid.minor = element_blank(), 
        strip.text = element_text(size = 15))

p_hardhoi = 
  betas %>% 
  filter(Coeff %in% c("betaijk", "betajik", "betakij")) %>% 
  ggplot(aes(x = pk, y = Value, color = Coeff)) + 
  geom_point(position = position_dodge(width = 0.5), size = 3) + 
  geom_line(position = position_dodge(width = 0.5)) + 
  scale_x_continuous(breaks = seq(1, 6, 1), name = expression(paste(p[k]))) +
  scale_y_continuous(name = "HOI Coefficient Value") +
  scale_color_manual(values = color_scheme_3, name = "", 
                     labels = c(expression(beta[i(jk)]), expression(beta[j(ik)]), expression(beta[k(ij)]))) + 
  ggh4x::facet_grid2(case ~ type, #scales = "free_y", independent = "y",
             labeller = labeller(type = c(semi_ic = "Low Overlap", 
                                          no_ic = "No Overlap", 
                                          yes_ic = "High Overlap"), 
                                 case = c(I = "I. Before", II = "II. Between", III = "III. After"))) +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), legend.position = "bottom", 
        panel.grid.minor = element_blank(), 
        strip.text = element_text(size = 15))
  
p_softhoi
p_hardhoi

```

Setting `data_dir` to `Data/Standard/` produces Figure S5;
Setting `data_dir` to `Data/m_ii_small/` produces Figure S9;
Setting `data_dir` to `Data/m_ij_small/` produces Figure S10.

```{r, eval = F}

ggsave("Plots/HardHOI.png", plot = p_hardhoi,
       device = "png", width = 2400, height = 2400, units = "px")

```

Setting `data_dir` to `Data/Standard/` produces Figure S11.

```{r}

ggsave("Plots/SoftHOI.png", plot = p_softhoi,
       device = "png", width = 2400, height = 2400, units = "px")

```

## Random Parameters

To run this section, change the data directory to `Data/Repetitions/`.

- Read Fitted Coefficients from Repeated Trials

```{r}

alphabetas_nc_reps = read_csv(paste0(data_dir, "alphabetas_nc_reps.csv"))
alphabetas_al_reps = read_csv(paste0(data_dir, "alphabetas_al_reps.csv"))
alphabetas_co_reps = read_csv(paste0(data_dir, "alphabetas_co_reps.csv"))

```

- Visualization

```{r}

alphabetas_al_rs = alphabetas_al_reps %>% 
  pivot_longer(starts_with("beta"), 
               names_to = "Coeff", values_to = "Value") %>% 
  mutate(type = "semi_ic")

alphabetas_nc_rs = alphabetas_nc_reps %>% 
  pivot_longer(starts_with("beta"), 
               names_to = "Coeff", values_to = "Value") %>% 
  mutate(type = "no_ic")

alphabetas_co_rs = alphabetas_co_reps %>% 
  pivot_longer(starts_with("beta"), 
               names_to = "Coeff", values_to = "Value") %>% 
  mutate(type = "yes_ic")

dta_bef = rbind(alphabetas_al_rs, alphabetas_nc_rs, alphabetas_co_rs) %>% 
  filter(pi == 5, pj == 5) %>% 
  mutate(case = "I")

dta_aft = rbind(alphabetas_al_rs, alphabetas_nc_rs, alphabetas_co_rs) %>% 
  filter(pi == 0, pj == 0) %>% 
  mutate(case = "III")

dta_btw = rbind(alphabetas_al_rs, alphabetas_nc_rs, alphabetas_co_rs) %>% 
  filter(pi == 0, pj == 5) %>% 
  mutate(case = "II")

betas = rbind(dta_bef, dta_aft, dta_btw) %>% 
  mutate(pk = pk+1)

p_softhoi_rep = 
  betas %>% 
  filter(Coeff %in% c("betaiik", "betajjk")) %>% 
  ggplot(aes(x = as.factor(pk), y = Value, color = Coeff)) + 
  geom_boxplot(position = position_dodge()) +
  # geom_point(position = position_jitter(), size = 0.5, alpha = 0.2) +
  # geom_line(position = position_dodge(width = 0.5)) + 
  # geom_smooth(position = position_dodge(width = 0.5)) +
  scale_x_discrete(breaks = seq(1, 6, 1), name = expression(paste(p[k]))) +
  scale_y_continuous(name = "HOI Coefficient Value") +
  scale_color_manual(values = color_scheme_3, name = "", 
                     labels = c(expression(beta[i(ik)]), expression(beta[j(jk)]))) + 
  scale_fill_manual(values = color_scheme_3, name = "", 
                     labels = c(expression(beta[i(jk)]), expression(beta[j(ik)]))) +
  ggh4x::facet_grid2(case ~ type, #scales = "free_y", independent = "y",
             labeller = labeller(type = c(semi_ic = "Low Overlap", 
                                          no_ic = "No Overlap", 
                                          yes_ic = "High Overlap"), 
                                 case = c(I = "I. Before", II = "II. Between", III = "III. After"))) +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), legend.position = "bottom", 
        panel.grid.minor = element_blank(), 
        strip.text = element_text(size = 15))

p_hardhoi_rep = 
  betas %>% 
  filter(Coeff %in% c("betaijk", "betajik", "betakij")) %>% 
  ggplot(aes(x = as.factor(pk), y = Value, color = Coeff)) + 
  geom_boxplot(position = position_dodge()) +
  # geom_point(position = position_jitter(), size = 0.5, alpha = 0.2) +
  # geom_line(position = position_dodge(width = 0.5)) +
  # geom_smooth(position = position_dodge(width = 0.5), aes(fill = Coeff)) +
  scale_x_discrete(breaks = seq(1, 6, 1), name = expression(paste(p[k]))) +
  scale_y_continuous(name = "HOI Coefficient Value") +
  scale_color_manual(values = color_scheme_3, name = "", 
                     labels = c(expression(beta[i(jk)]), expression(beta[j(ik)]), expression(beta[k(ij)]))) + 
  scale_fill_manual(values = color_scheme_3, name = "", 
                     labels = c(expression(beta[i(jk)]), expression(beta[j(ik)]), expression(beta[k(ij)]))) +
  ggh4x::facet_grid2(case ~ type, #scales = "free_y", independent = "y",
             labeller = labeller(type = c(semi_ic = "Low Overlap", 
                                          no_ic = "No Overlap", 
                                          yes_ic = "High Overlap"), 
                                 case = c(I = "I. Before", II = "II. Between", III = "III. After"))) +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), legend.position = "bottom", 
        panel.grid.minor = element_blank(), 
        strip.text = element_text(size = 15))
  
p_softhoi_rep
p_hardhoi_rep

```

Setting `data_dir` to `Data/Repetitions/` produces Figure S12-S13;
Setting `data_dir` to `Data/RealisticProp/` produces Figure S14-S15;

```{r, eval = F}

ggsave("Plots/SoftHOI_rep.png", plot = p_softhoi_rep,
       device = "png", width = 2400, height = 2400, units = "px")

ggsave("Plots/HardHOI_rep.png", plot = p_hardhoi_rep,
       device = "png", width = 2400, height = 2400, units = "px")

```

## Compare RMSE with Pairwise Models

```{r}

rmse_all = foreach(pk = 0:5, .combine = rbind) %dopar% {
  rbind(
    transform_dt(ijk_nc_rs, c(5, 5, pk)) %>% 
      mutate(type = "no_ic", case = "I") %>% 
      calculate_rmse() %>% 
      mutate(pk = pk),
    transform_dt(ijk_al_rs, c(5, 5, pk)) %>% 
      mutate(type = "semi_ic", case = "I") %>% 
      calculate_rmse() %>% 
      mutate(pk = pk),
    transform_dt(ijk_co_rs, c(5, 5, pk)) %>% 
      mutate(type = "yes_ic", case = "I") %>% 
      calculate_rmse() %>% 
      mutate(pk = pk),
    transform_dt(ijk_nc_rs, c(0, 0, pk)) %>% 
      mutate(type = "no_ic", case = "III") %>% 
      calculate_rmse() %>% 
      mutate(pk = pk),
    transform_dt(ijk_al_rs, c(0, 0, pk)) %>% 
      mutate(type = "semi_ic", case = "III") %>% 
      calculate_rmse() %>% 
      mutate(pk = pk),
    transform_dt(ijk_co_rs, c(0, 0, pk)) %>% 
      mutate(type = "yes_ic", case = "III") %>% 
      calculate_rmse() %>% 
      mutate(pk = pk),
    transform_dt(ijk_nc_rs, c(0, 5, pk)) %>% 
      mutate(type = "no_ic", case = "II") %>% 
      calculate_rmse() %>% 
      mutate(pk = pk),
    transform_dt(ijk_al_rs, c(0, 5, pk)) %>% 
      mutate(type = "semi_ic", case = "II") %>% 
      calculate_rmse() %>% 
      mutate(pk = pk),
    transform_dt(ijk_co_rs, c(0, 5, pk)) %>% 
      mutate(type = "yes_ic", case = "II") %>% 
      calculate_rmse() %>% 
      mutate(pk = pk)
  )
}

```

- Visualization

```{r}

p_rmse = rmse_all %>% 
  select(-AIC) %>% 
  pivot_wider(names_from = Model, values_from = RMSE) %>% 
  mutate(diff_RMSE = Pairwise - HOI) %>% # if positive, HOI performs better
  ggplot(aes(x = pk+1, y = diff_RMSE, color = as.factor(Species))) + 
  geom_line(position = position_dodge(width = 0.5)) + 
  geom_point(position = position_dodge(width = 0.5), size = 3) + 
  geom_hline(yintercept = 0, color = "black") +
  scale_x_continuous(breaks = seq(1, 6, 1), name = expression(paste(p[k]))) +
  scale_y_continuous(name = "RMSE(Pairwise) - RMSE(HOI)") +
  scale_color_manual(values = color_scheme_3, labels = c("i", "j"), name = "Focal Species") +
  ggh4x::facet_grid2(case ~ type, scales = "free_y", independent = "y",
             labeller = labeller(type = c(semi_ic = "Low Overlap", 
                                          no_ic = "No Overlap", 
                                          yes_ic = "High Overlap"), 
                                 case = c(I = "I. Before", II = "II. Between", III = "III. After"))) +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), legend.position = "bottom", 
        panel.grid.minor = element_blank(), 
        strip.text = element_text(size = 15))

p_rmse

```

```{r}

p_aic = rmse_all %>% 
  select(-RMSE) %>% 
  pivot_wider(names_from = Model, values_from = AIC) %>% 
  mutate(diff_AIC = Pairwise - HOI) %>% # if positive, HOI performs better
  ggplot(aes(x = pk+1, y = diff_AIC, color = as.factor(Species))) + 
  geom_line(position = position_dodge(width = 0.5)) + 
  geom_point(position = position_dodge(width = 0.5), size = 3) + 
  geom_hline(yintercept = 0, color = "black") +
  scale_x_continuous(breaks = seq(1, 6, 1), name = expression(paste(p[k]))) +
  scale_y_continuous(name = "AIC(Pairwise) - AIC(HOI)") +
  scale_color_manual(values = color_scheme_3, labels = c("i", "j"), name = "Focal Species") +
  ggh4x::facet_grid2(case ~ type, scales = "free_y", independent = "y",
             labeller = labeller(type = c(semi_ic = "Low Overlap", 
                                          no_ic = "No Overlap", 
                                          yes_ic = "High Overlap"), 
                                 case = c(I = "I. Before", II = "II. Between", III = "III. After"))) +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), legend.position = "bottom", 
        panel.grid.minor = element_blank(), 
        strip.text = element_text(size = 15))

p_aic

```

Setting `data_dir` to `Data/Standard/` produces Figure S16-S17;

```{r}

ggsave("Plots/RMSE.png", plot = p_rmse,
       device = "png", width = 2400, height = 2400, units = "px")

ggsave("Plots/AIC.png", plot = p_aic,
       device = "png", width = 2400, height = 2400, units = "px")

```

# Time-dependent Interaction Modification: Difference Method

## Model Fitting

```{r}

tau = 12
lc_len = 6

max_arriv = tau-lc_len-1

# Initials for the model fitting

inits = c(lambda = 3, alpha_intra = 0.2, alpha_inter1 = 0.2, alpha_inter2 = 0.2)
lowers = c(lambda = 1, alpha_intra = -3, alpha_inter1 = -3, alpha_inter2 = -3)
uppers = c(lambda = 5, alpha_intra = 3, alpha_inter1 = 3, alpha_inter2 = 3)

nls_ctrl = nls.control(maxiter = 1000, tol = 1e-8, minFactor = (1/10)*(1/1024),
                       printEval = FALSE, warnOnly = FALSE)

arriv_combns = rbind(tibble(i = 0, j = 0, k = seq(0, max_arriv, 1)),
                     tibble(i = max_arriv, j = max_arriv, k = seq(0, max_arriv, 1)),
                     tibble(i = 0, j = max_arriv, k = seq(0, max_arriv, 1))) %>%
  distinct()

set.seed(1)
alphas_al_rs = fit_all(arriv_combns, ijk_al_rs) %>%
  mutate(pij = pj-pi, pjk = pk-pj, pik = pk-pi)
alphas_nc_rs = fit_all(arriv_combns, ijk_nc_rs) %>%
  mutate(pij = pj-pi, pjk = pk-pj, pik = pk-pi)
alphas_co_rs = fit_all(arriv_combns, ijk_co_rs) %>%
  mutate(pij = pj-pi, pjk = pk-pj, pik = pk-pi)

```

## Visualization-Difference

- Calculation

```{r}

# Low overlap

alphas_al_rs_0 = alphas_ij_al_rs %>%
  pivot_longer(c("alphaii", "alphaij", "alphaji", "alphajj"), names_to = "Coeff", values_to = "Value") %>%
  filter((pi == 0 & pj == 0) | (pi == 5 & pj == 5) | (pi == 0 & pj == 5)) %>% 
  filter(pk == 0)

alphas_al_rs_delt = tibble()
for (i in 0:max(alphas_al_rs$pk)) {
  alphas_rs_i = alphas_al_rs %>%
    # filter(pi == 0 | pi == 0) %>%
    pivot_longer(c("alphaii", "alphaij", "alphaik", 
                   "alphaji", "alphajj", "alphajk", 
                   "alphaki", "alphakj", "alphakk"), names_to = "Coeff", values_to = "Value") %>%
    filter(pk == i) %>%
    filter(Coeff %in% c("alphaii", "alphaij", "alphaji", "alphajj")) %>%
    arrange(pi) %>% 
    mutate(Value0 = alphas_al_rs_0$Value, deltValue = Value - Value0, propValue = (Value - Value0)/Value0)
    # select(-Value0)
  alphas_al_rs_delt = rbind(alphas_al_rs_delt, alphas_rs_i)
}

# No overlap

alphas_nc_rs_0 = alphas_ij_nc_rs %>%
  pivot_longer(c("alphaii", "alphaij", "alphaji", "alphajj"), names_to = "Coeff", values_to = "Value") %>%
  filter((pi == 0 & pj == 0) | (pi == 5 & pj == 5) | (pi == 0 & pj == 5)) %>% 
  filter(pk == 0)

alphas_nc_rs_delt = tibble()
for (i in 0:max(alphas_nc_rs$pk)) {
  alphas_rs_i = alphas_nc_rs %>%
    # filter(pi == 0 | pi == 0) %>%
    pivot_longer(c("alphaii", "alphaij", "alphaik", 
                   "alphaji", "alphajj", "alphajk", 
                   "alphaki", "alphakj", "alphakk"), names_to = "Coeff", values_to = "Value") %>%
    filter(pk == i) %>%
    filter(Coeff %in% c("alphaii", "alphaij", "alphaji", "alphajj")) %>%
    arrange(pi) %>% 
    mutate(Value0 = alphas_nc_rs_0$Value, deltValue = Value - Value0, propValue = (Value - Value0)/Value0)
    # select(-Value0)
  alphas_nc_rs_delt = rbind(alphas_nc_rs_delt, alphas_rs_i)
}

# High overlap

alphas_co_rs_0 = alphas_ij_co_rs %>%
  pivot_longer(c("alphaii", "alphaij", "alphaji", "alphajj"), names_to = "Coeff", values_to = "Value") %>%
  filter((pi == 0 & pj == 0) | (pi == 5 & pj == 5) | (pi == 0 & pj == 5)) %>% 
  filter(pk == 0)

alphas_co_rs_delt = tibble()
for (i in 0:max(alphas_co_rs$pk)) {
  alphas_rs_i = alphas_co_rs %>%
    # filter(pi == 0 | pi == 0) %>%
    pivot_longer(c("alphaii", "alphaij", "alphaik", 
                   "alphaji", "alphajj", "alphajk", 
                   "alphaki", "alphakj", "alphakk"), names_to = "Coeff", values_to = "Value") %>%
    filter(pk == i) %>%
    filter(Coeff %in% c("alphaii", "alphaij", "alphaji", "alphajj")) %>%
    arrange(pi) %>% 
    mutate(Value0 = alphas_co_rs_0$Value, deltValue = Value - Value0, propValue = deltValue/Value0)
    # select(-Value0)
  alphas_co_rs_delt = rbind(alphas_co_rs_delt, alphas_rs_i)
}

dta_tdim_bef = rbind(
  alphas_al_rs_delt %>% 
    filter(pi == 5, pj == 5) %>% 
    filter(Coeff %in% c("alphaij", "alphaji")) %>% 
    mutate(type = "semi_ic"),
  alphas_nc_rs_delt %>% 
    filter(pi == 5, pj == 5) %>% 
    filter(Coeff %in% c("alphaij", "alphaji")) %>% 
    mutate(type = "no_ic"),
  alphas_co_rs_delt %>% 
    filter(pi == 5, pj == 5) %>% 
    filter(Coeff %in% c("alphaij", "alphaji")) %>% 
    mutate(type = "yes_ic")
) %>% mutate(case = "I")

dta_tdim_aft = rbind(
  alphas_al_rs_delt %>% 
    filter(pi == 0, pj == 0) %>% 
    filter(Coeff %in% c("alphaij", "alphaji")) %>% 
    mutate(type = "semi_ic"),  
  alphas_nc_rs_delt %>% 
    filter(pi == 0, pj == 0) %>% 
    filter(Coeff %in% c("alphaij", "alphaji")) %>% 
    mutate(type = "no_ic"),
  alphas_co_rs_delt %>% 
    filter(pi == 0, pj == 0) %>% 
    filter(Coeff %in% c("alphaij", "alphaji")) %>% 
    mutate(type = "yes_ic")
) %>% mutate(case = "III")

dta_tdim_btw = rbind(
  alphas_al_rs_delt %>% 
    filter(pi == 0, pj == 5) %>% 
    filter(Coeff %in% c("alphaij", "alphaji")) %>% 
    mutate(type = "semi_ic"),
  alphas_nc_rs_delt %>% 
    filter(pi == 0, pj == 5) %>% 
    filter(Coeff %in% c("alphaij", "alphaji")) %>% 
    mutate(type = "no_ic"),
  alphas_co_rs_delt %>% 
    filter(pi == 0, pj == 5) %>% 
    filter(Coeff %in% c("alphaij", "alphaji")) %>% 
    mutate(type = "yes_ic")
) %>% mutate(case = "II")

p_tdim = 
rbind(dta_tdim_bef, dta_tdim_aft, dta_tdim_btw) %>% 
  mutate(pk = pk + 1) %>% 
  ggplot(aes(x = pk, y = deltValue, color = Coeff)) + 
  geom_point(position = position_dodge(width = 0.5), size = 3) + 
  geom_line(position = position_dodge(width = 0.5)) +
  scale_x_continuous(breaks = seq(1, 6, 1), name = expression(paste(p[k]))) +
  scale_y_continuous(name = expression(paste("Interaction Modification (", Delta, alpha, ")"))) +
  scale_color_manual(values = color_scheme_3, name = "", 
                     labels = c(expression(ij), expression(ji))) + 
  ggh4x::facet_grid2(case ~ type, scales = "free_y", #independent = "y",
             labeller = labeller(type = c(semi_ic = "Low Overlap", 
                                          no_ic = "No Overlap", 
                                          yes_ic = "High Overlap"), 
                                 case = c(I = "I. Before", II = "II. Between", III = "III. After"))) +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), legend.position = "bottom", 
        panel.grid.minor = element_blank(), 
        strip.text = element_text(size = 15))

p_tdim

```

Setting `data_dir` to `Data/Standard/` produces Figure S18;

```{r, eval = F}

ggsave("Plots/TDIM_Diff.png", plot = p_tdim,
       device = "png", width = 2400, height = 2400, units = "px")

```

## Testing Robustness

- Model Fitting

First, the two-plant baselines with only three densities.

```{r}

ij_al_rs_sens = ij_al_rs %>% filter(init1 %in% c(1, 2, 3), init2 %in% c(1, 2, 3))
ij_nc_rs_sens = ij_nc_rs %>% filter(init1 %in% c(1, 2, 3), init2 %in% c(1, 2, 3))
ij_co_rs_sens = ij_co_rs %>% filter(init1 %in% c(1, 2, 3), init2 %in% c(1, 2, 3))

tau = 12
lc_len = 6

max_arriv = tau-lc_len-1

arriv_combns_ij = expand_grid(seq(0, max_arriv, 1), seq(0, max_arriv, 1), 0)

inits = c(lambda = 3, alpha_intra = 0.2, alpha_inter = 0.2)
lowers = c(lambda = 1, alpha_intra = -1, alpha_inter = -1)
uppers = c(lambda = 5, alpha_intra = 1, alpha_inter = 1)

nls_ctrl = nls.control(maxiter = 1000, tol = 1e-8, minFactor = (1/10)*(1/1024),
                       printEval = FALSE, warnOnly = FALSE)

alphas_ij_al_rs_sens = fit_all_2(arriv_combns_ij, ij_al_rs, c(1, 2)) %>% mutate(pij = pj-pi)
alphas_ij_nc_rs_sens = fit_all_2(arriv_combns_ij, ij_nc_rs, c(1, 2)) %>% mutate(pij = pj-pi)
alphas_ij_co_rs_sens = fit_all_2(arriv_combns_ij, ij_co_rs, c(1, 2)) %>% mutate(pij = pj-pi)


# Visualization

alphas_all_2 = bind_rows(
  alphas_ij_al_rs_sens %>% 
    filter(pk == 0) %>%
    filter(pi == 0 | pj == 0) %>% 
    arrange(pij) %>% 
    mutate(type = "semi_ic"),
  alphas_ij_nc_rs_sens %>% 
    filter(pk == 0) %>%
    filter(pi == 0 | pj == 0) %>% 
    arrange(pij) %>% 
    mutate(type = "no_ic"), 
  alphas_ij_co_rs_sens %>% 
    filter(pk == 0) %>%
    filter(pi == 0 | pj == 0) %>% 
    arrange(pij) %>% 
    mutate(type = "yes_ic"), 
)

p_alpha_2spp = 
alphas_all_2 %>% 
  pivot_longer(c(alphaii, alphaij, alphaji, alphajj), names_to = "Coeff", values_to = "Value") %>%
  filter(Coeff %in% c("alphaij", "alphaji")) %>%
  # filter(type != "yes_ic") %>%
  ggplot(aes(x = pij, y = Value, color = Coeff)) + 
  geom_line() + 
  geom_point(size = 3) + 
  scale_x_continuous(name = expression(paste(Delta, p[ij])), 
                     breaks = seq(-5, 5, 1)) +
  ylab("Coefficients") +
  scale_color_manual(values = color_scheme_3, 
                     name = "", labels = c(expression(alpha[ij]), expression(alpha[ji]))) +
  facet_wrap(~ type, strip.position = "top", 
             labeller = labeller(type = c(semi_ic = "Low Overlap",
                                          no_ic = "No Overlap", 
                                          yes_ic = "High Overlap"))) +
  ggtitle("C") +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), legend.position = "bottom", 
        panel.grid.minor = element_blank(), 
        plot.title = element_text(size = 20),
        strip.text.x = element_blank(), strip.background = element_blank())

p_alpha_2spp

```

Then, the three-plant model with three densities for focal pair, and one density for $k$

```{r}

ijk_al_rs_sens = ijk_al_rs %>% filter(init3 == 1, init1 %in% c(1, 2, 3), init2 %in% c(1, 2, 3))
ijk_nc_rs_sens = ijk_nc_rs %>% filter(init3 == 1, init1 %in% c(1, 2, 3), init2 %in% c(1, 2, 3))
ijk_co_rs_sens = ijk_co_rs %>% filter(init3 == 1, init1 %in% c(1, 2, 3), init2 %in% c(1, 2, 3))

inits = c(lambda = 3, alpha_intra = 0.2, alpha_inter = 0.2)
lowers = c(lambda = 1, alpha_intra = -1, alpha_inter = -1)
uppers = c(lambda = 5, alpha_intra = 1, alpha_inter = 1)

nls_ctrl = nls.control(maxiter = 1000, tol = 1e-8, minFactor = (1/10)*(1/1024),
                       printEval = FALSE, warnOnly = FALSE)

max_arriv = tau-lc_len-1
arriv_combns = rbind(tibble(i = 0, j = 0, k = seq(0, max_arriv, 1)),
                     tibble(i = max_arriv, j = max_arriv, k = seq(0, max_arriv, 1)),
                     tibble(i = 0, j = max_arriv, k = seq(0, max_arriv, 1))) %>%
  distinct()

alphas_al_rs_sens = fit_all_2(arriv_combns, ijk_al_rs_sens, c(1, 2)) %>%
  mutate(pij = pj-pi, pjk = pk-pj, pik = pk-pi)
alphas_nc_rs_sens = fit_all_2(arriv_combns, ijk_nc_rs_sens, c(1, 2)) %>%
  mutate(pij = pj-pi, pjk = pk-pj, pik = pk-pi)
alphas_co_rs_sens = fit_all_2(arriv_combns, ijk_co_rs_sens, c(1, 2)) %>%
  mutate(pij = pj-pi, pjk = pk-pj, pik = pk-pi)

```

- Calculation

```{r}

# Low overlap

alphas_al_rs_0 = alphas_ij_al_rs_sens %>%
  pivot_longer(c("alphaii", "alphaij", "alphaji", "alphajj"), names_to = "Coeff", values_to = "Value") %>%
  filter((pi == 0 & pj == 0) | (pi == 5 & pj == 5) | (pi == 0 & pj == 5)) %>% 
  filter(pk == 0)

alphas_al_rs_delt = tibble()
for (i in 0:max(alphas_al_rs_sens$pk)) {
  alphas_rs_i = alphas_al_rs_sens %>%
    # filter(pi == 0 | pi == 0) %>%
    pivot_longer(c("alphaii", "alphaij", 
                   "alphaji", "alphajj"), names_to = "Coeff", values_to = "Value") %>%
    filter(pk == i) %>%
    filter(Coeff %in% c("alphaii", "alphaij", "alphaji", "alphajj")) %>%
    arrange(pi) %>% 
    mutate(Value0 = alphas_al_rs_0$Value, deltValue = Value - Value0, propValue = (Value - Value0)/Value0)
    # select(-Value0)
  alphas_al_rs_delt = rbind(alphas_al_rs_delt, alphas_rs_i)
}

# No overlap

alphas_nc_rs_0 = alphas_ij_nc_rs_sens %>%
  pivot_longer(c("alphaii", "alphaij", "alphaji", "alphajj"), names_to = "Coeff", values_to = "Value") %>%
  filter((pi == 0 & pj == 0) | (pi == 5 & pj == 5) | (pi == 0 & pj == 5)) %>% 
  filter(pk == 0)

alphas_nc_rs_delt = tibble()
for (i in 0:max(alphas_nc_rs_sens$pk)) {
  alphas_rs_i = alphas_nc_rs_sens %>%
    # filter(pi == 0 | pi == 0) %>%
    pivot_longer(c("alphaii", "alphaij", 
                   "alphaji", "alphajj"), names_to = "Coeff", values_to = "Value") %>%
    filter(pk == i) %>%
    filter(Coeff %in% c("alphaii", "alphaij", "alphaji", "alphajj")) %>%
    arrange(pi) %>% 
    mutate(Value0 = alphas_nc_rs_0$Value, deltValue = Value - Value0, propValue = (Value - Value0)/Value0)
    # select(-Value0)
  alphas_nc_rs_delt = rbind(alphas_nc_rs_delt, alphas_rs_i)
}

# High overlap

alphas_co_rs_0 = alphas_ij_co_rs_sens %>%
  pivot_longer(c("alphaii", "alphaij", "alphaji", "alphajj"), names_to = "Coeff", values_to = "Value") %>%
  filter((pi == 0 & pj == 0) | (pi == 5 & pj == 5) | (pi == 0 & pj == 5)) %>% 
  filter(pk == 0)

alphas_co_rs_delt = tibble()
for (i in 0:max(alphas_co_rs_sens$pk)) {
  alphas_rs_i = alphas_co_rs_sens %>%
    # filter(pi == 0 | pi == 0) %>%
    pivot_longer(c("alphaii", "alphaij",  
                   "alphaji", "alphajj"), names_to = "Coeff", values_to = "Value") %>%
    filter(pk == i) %>%
    filter(Coeff %in% c("alphaii", "alphaij", "alphaji", "alphajj")) %>%
    arrange(pi) %>% 
    mutate(Value0 = alphas_co_rs_0$Value, deltValue = Value - Value0, propValue = deltValue/Value0)
    # select(-Value0)
  alphas_co_rs_delt = rbind(alphas_co_rs_delt, alphas_rs_i)
}

dta_tdim_bef = rbind(
  alphas_al_rs_delt %>% 
    filter(pi == 5, pj == 5) %>% 
    filter(Coeff %in% c("alphaij", "alphaji")) %>% 
    mutate(type = "semi_ic"),
  alphas_nc_rs_delt %>% 
    filter(pi == 5, pj == 5) %>% 
    filter(Coeff %in% c("alphaij", "alphaji")) %>% 
    mutate(type = "no_ic"),
  alphas_co_rs_delt %>% 
    filter(pi == 5, pj == 5) %>% 
    filter(Coeff %in% c("alphaij", "alphaji")) %>% 
    mutate(type = "yes_ic")
) %>% mutate(case = "I")

dta_tdim_aft = rbind(
  alphas_al_rs_delt %>% 
    filter(pi == 0, pj == 0) %>% 
    filter(Coeff %in% c("alphaij", "alphaji")) %>% 
    mutate(type = "semi_ic"),  
  alphas_nc_rs_delt %>% 
    filter(pi == 0, pj == 0) %>% 
    filter(Coeff %in% c("alphaij", "alphaji")) %>% 
    mutate(type = "no_ic"),
  alphas_co_rs_delt %>% 
    filter(pi == 0, pj == 0) %>% 
    filter(Coeff %in% c("alphaij", "alphaji")) %>% 
    mutate(type = "yes_ic")
) %>% mutate(case = "III")

dta_tdim_btw = rbind(
  alphas_al_rs_delt %>% 
    filter(pi == 0, pj == 5) %>% 
    filter(Coeff %in% c("alphaij", "alphaji")) %>% 
    mutate(type = "semi_ic"),
  alphas_nc_rs_delt %>% 
    filter(pi == 0, pj == 5) %>% 
    filter(Coeff %in% c("alphaij", "alphaji")) %>% 
    mutate(type = "no_ic"),
  alphas_co_rs_delt %>% 
    filter(pi == 0, pj == 5) %>% 
    filter(Coeff %in% c("alphaij", "alphaji")) %>% 
    mutate(type = "yes_ic")
) %>% mutate(case = "II")

p_tdim_sens = 
rbind(dta_tdim_bef, dta_tdim_aft, dta_tdim_btw) %>% 
  mutate(pk = pk + 1) %>% 
  ggplot(aes(x = pk, y = deltValue, color = Coeff)) + 
  geom_point(position = position_dodge(width = 0.5), size = 3) + 
  geom_line(position = position_dodge(width = 0.5)) +
  scale_x_continuous(breaks = seq(1, 6, 1), name = expression(paste(p[k]))) +
  scale_y_continuous(name = expression(paste("Interaction Modification (", Delta, alpha, ")"))) +
  scale_color_manual(values = color_scheme_3, name = "", 
                     labels = c(expression(ij), expression(ji))) + 
  ggh4x::facet_grid2(case ~ type, scales = "free_y", #independent = "y",
             labeller = labeller(type = c(semi_ic = "Low Overlap", 
                                          no_ic = "No Overlap", 
                                          yes_ic = "High Overlap"), 
                                 case = c(I = "I. Before", II = "II. Between", III = "III. After"))) +
  theme_bw() + 
  theme(axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), 
        axis.title.x = element_text(size = 20), axis.title.y = element_text(size = 20), 
        legend.text = element_text(size = 17), legend.title = element_text(size = 20), legend.position = "bottom", 
        panel.grid.minor = element_blank(), 
        strip.text = element_text(size = 15))

p_tdim_sens

```

Setting `data_dir` to `Data/Standard/` produces Figure S19;

```{r, eval = F}

ggsave("Plots/Sens.png", plot = p_tdim_sens,
       device = "png", width = 2400, height = 2400, units = "px")

```